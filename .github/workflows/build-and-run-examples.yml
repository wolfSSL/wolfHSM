name: Build and Run Examples

on:
  push:
    branches: [ 'master', 'main', 'release/**' ]
  pull_request:
    branches: [ '*' ]

jobs:
  build:
    strategy:
        matrix:
            transport: [ 'tcp', 'shm' ]
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - uses: actions/checkout@master

    # pull and build wolfssl
    - name: Checkout wolfssl
      uses: actions/checkout@master
      with:
        repository: wolfssl/wolfssl
        path: wolfssl

    # Build examples
    - name: Build POSIX TCP server
      run: cd examples/posix/wh_server_posix && make -j WOLFSSL_DIR=../../../wolfssl
    - name: Build POSIX TCP client
      run: cd examples/posix/wh_client_posix && make -j WOLFSSL_DIR=../../../wolfssl

    # Start the server in the background
    - name: Run POSIX TCP server
      run: |
        cd examples/posix/wh_server_posix
        ./Build/wh_server_posix.elf --type ${{ matrix.transport }} &
        POSIX_SERVER_PID=$!
        echo "POSIX_SERVER_PID=$POSIX_SERVER_PID" >> $GITHUB_ENV

    # Run the client that connects to the server
    - name: Run POSIX TCP client
      run: |
        cd examples/posix/wh_client_posix
        ./Build/wh_client_posix.elf --type ${{ matrix.transport }}

    # Optional: Kill the server process if it doesn't exit on its own
    - name: Cleanup POSIX TCP server
      if: always()
      run: kill $POSIX_SERVER_PID || true


